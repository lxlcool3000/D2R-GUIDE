        let currentClass = 'home';
        let chartInstance = null;
        
        const mainContent = document.getElementById('main-content');
        const classNav = document.getElementById('class-nav');
        const runeModal = document.getElementById('runeModal');
        const tipsModal = document.getElementById('tipsModal');
        const gearModal = document.getElementById('gearModal');
        const baseModal = document.getElementById('baseModal');
        const mfBossModal = document.getElementById('mfBossModal');
        const aiModal = document.getElementById('aiModal');
        const bpModal = document.getElementById('bpModal');
        const mercModal = document.getElementById('mercModal');
        const craftingModal = document.getElementById('craftingModal');

        const runeListContainer = document.getElementById('runeListContainer');
        const tipsListContainer = document.getElementById('tipsListContainer');
        const gearListContainer = document.getElementById('gearListContainer');
        const baseListContainer = document.getElementById('baseListContainer');
        const mfBossListContainer = document.getElementById('mfBossListContainer');
        const mercListContainer = document.getElementById('mercListContainer');
        const craftingListContainer = document.getElementById('craftingListContainer');

        const runeSearch = document.getElementById('runeSearch');
        const runeTypeFilter = document.getElementById('runeTypeFilter');
        const runeSocketFilter = document.getElementById('runeSocketFilter');
        const gearSearch = document.getElementById('gearSearch');
        const gearTypeFilter = document.getElementById('gearTypeFilter');

        const aiClassSelect = document.getElementById('aiClassSelect');
        const aiQueryInput = document.getElementById('aiQueryInput');
        const aiResponseContainer = document.getElementById('aiResponseContainer');

        const bpClassSelect = document.getElementById('bpClassSelect');
        const bpTypeSelect = document.getElementById('bpTypeSelect');
        const bpResultContainer = document.getElementById('bpResultContainer');


        function formatRunewordFormula(formula) {
            return formula.split('+').map(num => {
                const rune = db.runes.find(r => r.id == num);
                return rune ? `<span class="whitespace-nowrap">${num}#${rune.zh}</span>` : '';
            }).join(' + ');
        }
        
        function renderRunes() {
            const query = runeSearch.value.toLowerCase();
            const type = runeTypeFilter.value;
            const sockets = runeSocketFilter.value;

            // Filter individual runes
            const filteredRunes = db.runes.filter(rune => {
                return rune.zh.toLowerCase().includes(query) || 
                       rune.en.toLowerCase().includes(query) || 
                       rune.tw.toLowerCase().includes(query) ||
                       rune.id.toString() === query;
            });

            // Filter runewords
            const filteredRunewords = db.runewords.filter(rw => {
                const nameMatch = rw.name.toLowerCase().includes(query);
                const typeMatch = type === 'all' || rw.type.includes(type);
                const socketMatch = sockets === 'all' || rw.sockets == sockets;
                return (query === '' || nameMatch) && typeMatch && socketMatch;
            });
            
            let html = '';

            if(query !== '' && filteredRunes.length > 0) {
                html += '<h4 class="text-amber-500 font-bold text-lg mb-2">符文查询结果</h4>';
                html += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 mb-6">';
                filteredRunes.forEach(rune => {
                    html += `<div class="bg-stone-800 p-2 rounded text-stone-300"><strong>${rune.id}#</strong> ${rune.zh} / ${rune.tw} (${rune.en})</div>`;
                });
                html += '</div>';
            }


            html += '<h4 class="text-amber-500 font-bold text-lg mb-2">符文之语</h4>';
            html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
            filteredRunewords.forEach(rw => {
                html += `
                    <div class="bg-stone-800 p-3 rounded">
                        <p class="font-bold text-amber-400">${rw.name} <span class="text-stone-400 font-normal text-sm">(Lv ${rw.level})</span></p>
                        <p class="text-sm text-stone-400">${rw.base}</p>
                        <p class="text-stone-300 mt-1">${formatRunewordFormula(rw.formula)}</p>
                    </div>
                `;
            });
            html += '</div>';

            if(filteredRunewords.length === 0 && filteredRunes.length === 0) {
                 html = '<p class="text-stone-400 text-center py-4">未找到匹配的结果。</p>';
            }
            runeListContainer.innerHTML = html;
        }

        function renderTips() {
            let html = '';
            db.tips.forEach(tip => {
                html += `
                    <div class="bg-stone-800 p-4 rounded-lg border border-stone-700">
                        <h4 class="font-bold text-lg text-amber-400 mb-2">${tip.title}</h4>
                        <div class="text-stone-300">${tip.content}</div>
                    </div>
                `;
            });
            tipsListContainer.innerHTML = html;
        }

        function renderTopGear() {
            const query = gearSearch.value.toLowerCase();
            const type = gearTypeFilter.value;

            const filteredGear = db.topGear.filter(item => {
                const nameMatch = item.name.toLowerCase().includes(query);
                const typeMatch = type === 'all' || item.category.includes(type);
                return nameMatch && typeMatch;
            });

            let html = '<div class="grid md:grid-cols-2 gap-4">';
            filteredGear.forEach(item => {
                let statsHtml = item.key_stats.map(stat => `<li>${stat}</li>`).join('');
                html += `
                    <div class="bg-stone-800 p-4 rounded-lg border border-stone-700 flex flex-col">
                        <h4 class="font-bold text-lg text-amber-400">${item.name}</h4>
                        <p class="text-sm text-stone-400 mb-2">${item.type}</p>
                        <ul class="list-disc list-inside text-stone-300 space-y-1 flex-grow">${statsHtml}</ul>
                        <p class="mt-3 pt-3 border-t border-stone-600 text-amber-500 text-sm"><strong>适用:</strong> ${item.best_for}</p>
                    </div>
                `;
            });
            html += '</div>';
            if(filteredGear.length === 0) {
                 html = '<p class="text-stone-400 text-center py-4">未找到匹配的装备。</p>';
            }
            gearListContainer.innerHTML = html;
        }
        
        function renderUsefulBases() {
            let html = '';
            db.usefulBases.forEach(category => {
                html += `<div class="bg-stone-800 p-4 rounded-lg border border-stone-700"><h4 class="text-amber-500 font-bold text-lg mb-3">${category.category}</h4>`;
                if(category.intro) {
                     html += `<p class="text-sm text-stone-400 mb-4">${category.intro}</p>`;
                }
                html += '<div class="grid md:grid-cols-2 gap-4">';
                category.items.forEach(item => {
                    html += `
                        <div class="bg-stone-900 p-4 rounded">
                            <p class="font-bold text-amber-400 text-lg">${item.icon} ${item.name}</p>
                            ${item.sockets ? `<p class="text-sm text-stone-400 mb-2"><strong>需求孔数:</strong> ${item.sockets}</p>` : ''}
                            <p class="text-stone-300">${item.why}</p>
                            ${item.tip ? `<p class="text-xs text-amber-400/80 mt-2"><strong>提示:</strong> ${item.tip}</p>` : ''}
                        </div>
                    `;
                });
                html += '</div></div>';
            });
            baseListContainer.innerHTML = html;
        }

        function renderMfBossList() {
             let html = '';
            db.mfTargets.forEach(target => {
                html += `
                    <div class="bg-stone-800 p-4 rounded-lg border border-stone-700">
                        <h4 class="font-bold text-lg text-amber-400 mb-1">${target.name}</h4>
                        <p class="text-sm text-stone-400 mb-2"><strong>位置:</strong> ${target.location}</p>
                        <p class="text-stone-300 mb-2">${target.why}</p>
                        <p class="text-amber-500 text-sm"><strong>推荐职业:</strong> ${target.recommended}</p>
                    </div>
                `;
            });
            mfBossListContainer.innerHTML = html;
        }

        function renderMercenaries() {
            let html = '';
            db.mercenaries.forEach(category => {
                html += `<h4 class="text-amber-500 font-bold text-lg mb-3">${category.category}</h4>`;
                html += '<div class="grid md:grid-cols-2 gap-4 mb-6">';
                category.items.forEach(item => {
                    html += `
                        <div class="bg-stone-800 p-4 rounded-lg border border-stone-700">
                            <p class="font-bold text-amber-400 text-lg">${item.icon} ${item.name}</p>
                            <div class="text-stone-300">${item.why}</div>
                        </div>
                    `;
                });
                html += '</div>';
            });
            mercListContainer.innerHTML = html;
        }

        function renderCrafting() {
            let html = '';
            db.crafting.forEach(category => {
                html += `<div class="mb-6"><h4 class="text-amber-500 font-bold text-lg mb-3">${category.name}</h4>`
                html += `<p class="text-stone-300 mb-4">${category.intro}</p>`;
                category.recipes.forEach(recipe => {
                    html += `
                        <div class="bg-stone-800 p-4 rounded-lg border border-stone-700 mb-4">
                            <h5 class="font-bold text-lg text-amber-400 mb-2">${recipe.name}</h5>
                            <p class="text-stone-300"><strong class="text-amber-500">公式:</strong> ${recipe.formula}</p>
                            <div class="text-stone-300 mt-2">${recipe.stats}</div>
                        </div>
                    `;
                });
                html += `</div>`;
            });
            craftingListContainer.innerHTML = html;
        }

        function populateAIClassSelect() {
            db.classes.forEach(cls => {
                if (cls.id !== 'home') {
                    const option = document.createElement('option');
                    option.value = cls.id;
                    option.textContent = cls.name;
                    aiClassSelect.appendChild(option);
                }
            });
        }
        
        async function getAIAdvice() {
            const selectedClassId = aiClassSelect.value;
            const userQuery = aiQueryInput.value;

            if (!selectedClassId || !userQuery.trim()) {
                aiResponseContainer.innerHTML = '<p class="text-red-400">请选择一个职业并描述你的问题。</p>';
                return;
            }

            aiResponseContainer.innerHTML = '<div class="flex justify-center items-center h-full"><div class="loader"></div></div>';
            
            const classInfo = classData[selectedClassId];
            let context = `职业: ${classInfo.title}\n简介: ${classInfo.intro}\n`;
            classInfo.sections.forEach(sec => {
                context += `${sec.title}:\n${sec.content.replace(/<[^>]*>/g, ' ')}\n\n`;
            });
            
            const systemPrompt = `你是一位名为“迪卡·凯恩”的《暗黑破坏神2》专家顾问。你的所有知识都严格基于我提供的攻略文本。请使用中文，用迪卡·凯恩的口吻（“Stay a while and listen...”的风格）来回答玩家的问题。你的回答必须简洁、有条理，并直接引用或总结我提供的攻略内容，为玩家推荐最合适的玩法和装备。`;
            const userPrompt = `这是关于一个职业的攻略资料：\n\n${context}\n\n---
            现在，请根据以上资料，回答这位玩家的问题： "${userQuery}"`;
            
            /* apiKey removed: server-side */
            const apiUrl = '/api/ai-advice';

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ systemPrompt, userPrompt }) });

                if (!response.ok) {
                    throw new Error(`API 请求失败，状态码: ${response.status}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    let text = candidate.content.parts[0].text;
                    text = text.replace(/\n/g, '<br>');
                    aiResponseContainer.innerHTML = `<p>${text}</p>`;
                } else {
                    throw new Error("未能从API获取有效回复。");
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                aiResponseContainer.innerHTML = '<p class="text-red-400">抱歉，赫拉迪姆的智慧暂时无法连接。请稍后再试。</p>';
            }
        }

        function populateBpSelectors() {
            bpClassSelect.innerHTML = '';
            let firstClassId = '';
            db.classes.forEach(cls => {
                if (cls.id !== 'home') {
                    if(!firstClassId) firstClassId = 'necromancer';
                    const option = document.createElement('option');
                    option.value = cls.id;
                    option.textContent = cls.name;
                    bpClassSelect.appendChild(option);
                }
            });
            bpClassSelect.value = firstClassId;

            bpTypeSelect.innerHTML = '';
            Object.keys(db.breakpoints).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = db.breakpoints[key].name;
                bpTypeSelect.appendChild(option);
            });
            
            bpClassSelect.addEventListener('change', renderBreakpoints);
            bpTypeSelect.addEventListener('change', renderBreakpoints);
        }

        function renderBreakpoints() {
            const classId = bpClassSelect.value;
            const type = bpTypeSelect.value;
            const bpTypeData = db.breakpoints[type];
            let html = '';

            if (!bpTypeData) {
                bpResultContainer.innerHTML = '';
                return;
            }
            
            const classBpData = bpTypeData[classId];

            let dataSets;
            if (classId === 'druid' && type === 'fhr') {
                dataSets = { "人形": bpTypeData.druid_human, "狼人": bpTypeData.druid_wolf, "熊人": bpTypeData.druid_bear };
            } else if (typeof classBpData === 'object' && !Array.isArray(classBpData)) {
                dataSets = classBpData;
            } else if (Array.isArray(classBpData)) {
                dataSets = { [bpTypeData.name]: classBpData };
            } else {
                bpResultContainer.innerHTML = '<p class="text-stone-400 text-center py-4">该职业无此档位数据。</p>';
                return;
            }
            
            html += `<p class="text-sm text-stone-400 mb-4">注意：IAS(提升攻击速度)档位因武器、技能不同而极其复杂，建议使用专门的IAS计算器查询。</p>`;
            
            const frames = {
                fcr: {"施法": [15, 14, 13, 12, 11, 10, 9, 8, 7], "人形施法": [18, 17, 16, 15, 14, 13, 12, 11, 10], "闪电/连锁闪电": [13, 12, 11, 10, 9, 8, 7, 6, 5], "其他技能": [13, 12, 11, 10, 9, 8, 7] },
                fhr: { amazon: [11,10,9,8,7,6,5,4,3], assassin: [13,12,11,10,9,8,7,6], barbarian: [13,12,11,10,9,8,7,6], necromancer: [13,12,11,10,9,8,7,6,5,4], paladin: [9,8,7,6,5,4,3], sorceress: [15,14,13,12,11,10,9,8,7,6,5], "人形": [14,13,12,11,10,9,8,7,6,5], "狼人": [11,10,9,8,7,6,5,4,3], "熊人": [13,12,11,10,9,8,7,6,5] },
                fbr: { paladin: [4,3,2,1], amazon: [5,4,3,2,1], assassin: [7,6,5,4,3,2,1], barbarian: [7,6,5,4,3,2,1], druid: [7,6,5,4,3,2,1], necromancer: [7,6,5,4,3,2,1], sorceress: [9,8,7,6,5,4,3] }
            };

            for (const subType in dataSets) {
                const values = dataSets[subType];
                if (!Array.isArray(values)) continue;
                
                let frameData;
                 if(type === 'fcr') frameData = frames.fcr[subType] || frames.fcr['施法'];
                 else if(type === 'fhr') frameData = frames.fhr[classId] || frames.fhr[subType] || frames.fhr[classId.split('_')[0]];
                 else if(type === 'fbr') frameData = frames.fbr[classId] || frames.fbr.default;

                html += `<h4 class="font-bold text-amber-400 text-lg mb-2">${subType}</h4>`;
                html += `<div class="overflow-x-auto"><table class="w-full text-sm text-left text-stone-300">`;
                html += `<thead class="text-xs text-amber-400 uppercase bg-stone-700"><tr>`;
                
                let headers = ``;
                let cells = ``;
                values.slice(1).forEach((val, i) => {
                    if(frameData && frameData[i]){
                       headers += `<th class="px-6 py-3 text-center">${frameData[i]}F</th>`;
                       cells += `<td class="px-6 py-4 text-center">${val}</td>`;
                    }
                });

                html += `<th class="px-6 py-3">帧数 (Frames)</th>` + headers;
                html += `</tr></thead><tbody><tr class="bg-stone-800 border-b border-stone-600"><td class="px-6 py-4 font-medium">需要 ${bpTypeData.name} (%)</td>` + cells;
                html += `</tr></tbody></table></div>`;
            }

            bpResultContainer.innerHTML = html;
        }


        function toggleRuneModal() {
            if (runeModal.classList.contains('opacity-0')) {
                runeModal.classList.remove('opacity-0', 'pointer-events-none');
                renderRunes();
            } else {
                runeModal.classList.add('opacity-0', 'pointer-events-none');
            }
        }

        function toggleTipsModal() {
            if (tipsModal.classList.contains('opacity-0')) {
                tipsModal.classList.remove('opacity-0', 'pointer-events-none');
                renderTips();
            } else {
                tipsModal.classList.add('opacity-0', 'pointer-events-none');
            }
        }
        
        function toggleGearModal() {
            if (gearModal.classList.contains('opacity-0')) {
                gearModal.classList.remove('opacity-0', 'pointer-events-none');
                renderTopGear();
            } else {
                gearModal.classList.add('opacity-0', 'pointer-events-none');
            }
        }

        function toggleBaseModal() {
            if (baseModal.classList.contains('opacity-0')) {
                baseModal.classList.remove('opacity-0', 'pointer-events-none');
                renderUsefulBases();
            } else {
                baseModal.classList.add('opacity-0', 'pointer-events-none');
            }
        }

        function toggleMfBossModal() {
            if (mfBossModal.classList.contains('opacity-0')) {
                mfBossModal.classList.remove('opacity-0', 'pointer-events-none');
                renderMfBossList();
            } else {
                mfBossModal.classList.add('opacity-0', 'pointer-events-none');
            }
        }

        function toggleAIModal() {
            if (aiModal.classList.contains('opacity-0')) {
                aiModal.classList.remove('opacity-0', 'pointer-events-none');
            } else {
                aiModal.classList.add('opacity-0', 'pointer-events-none');
            }
        }
        
        function toggleBpModal() {
            if (bpModal.classList.contains('opacity-0')) {
                bpModal.classList.remove('opacity-0', 'pointer-events-none');
                bpTypeSelect.value = 'fcr';
                renderBreakpoints();
            } else {
                bpModal.classList.add('opacity-0', 'pointer-events-none');
            }
        }
        
        function toggleMercModal() {
            if (mercModal.classList.contains('opacity-0')) {
                mercModal.classList.remove('opacity-0', 'pointer-events-none');
                renderMercenaries();
            } else {
                mercModal.classList.add('opacity-0', 'pointer-events-none');
            }
        }
        
        function toggleCraftingModal() {
            if (craftingModal.classList.contains('opacity-0')) {
                craftingModal.classList.remove('opacity-0', 'pointer-events-none');
                renderCrafting();
            } else {
                craftingModal.classList.add('opacity-0', 'pointer-events-none');
            }
        }

        runeSearch.addEventListener('input', renderRunes);
        runeTypeFilter.addEventListener('change', renderRunes);
        runeSocketFilter.addEventListener('change', renderRunes);
        gearSearch.addEventListener('input', renderTopGear);
        gearTypeFilter.addEventListener('change', renderTopGear);
        
        function renderContent(classId) {
            const data = classData[classId];
            if (!data) return;

            let contentHtml = `
                <div class="content-section active" id="content-${classId}">
                    <h2 class="text-3xl font-bold text-amber-400 mb-2">${data.title}</h2>
                    <p class="text-stone-300 mb-8 max-w-4xl">${data.intro}</p>
                    ${data.content || ''}
            `;

            if(data.sections) {
                data.sections.forEach(section => {
                    contentHtml += `
                        <div class="mb-8">
                            <h3 class="text-2xl font-semibold text-amber-500 mb-4 pb-2 border-b-2 border-stone-600">${section.title}</h3>
                            <div>${section.content}</div>
                        </div>
                    `;
                });
            }

            contentHtml += `</div>`;
            mainContent.innerHTML = contentHtml;

            if (classId === 'home') {
                renderRadarChart();
            }
        }
        
        function navigate(classId) {
            if (currentClass === classId && classId !== 'home') return;
            currentClass = classId;
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.classId === classId) {
                    item.classList.add('active');
                }
            });

            renderContent(classId);
            window.scrollTo(0, 0);
        }

        function renderNav() {
            let navHtml = '';
            db.classes.forEach(cls => {
                navHtml += `
                    <button class="nav-item flex flex-col items-center p-2 rounded-lg border border-transparent" data-class-id="${cls.id}" onclick="navigate('${cls.id}')">
                        <span class="text-3xl mb-1">${cls.icon}</span>
                        <span class="font-semibold text-sm text-stone-300">${cls.name}</span>
                    </button>
                `;
            });
            classNav.innerHTML = navHtml;
        }

        function renderRadarChart() {
            const ctx = document.getElementById('classComparisonChart');
            if (!ctx) return;
            if (chartInstance) {
                chartInstance.destroy();
            }
            const data = {
                labels: ['清场速度', '单体伤害', '生存能力', '团队辅助', '机动性', '开荒友好度', 'Boss击杀能力'],
                datasets: [
                    { label: '死灵法师', data: [9, 6, 9, 9, 3, 9, 7], fill: true, backgroundColor: 'rgba(130, 130, 130, 0.2)', borderColor: 'rgb(200, 200, 200)', pointBackgroundColor: 'rgb(200, 200, 200)'},
                    { label: '圣骑士', data: [10, 9, 8, 9, 4, 8, 10], fill: true, backgroundColor: 'rgba(54, 162, 235, 0.2)', borderColor: 'rgb(54, 162, 235)', pointBackgroundColor: 'rgb(54, 162, 235)'},
                    { label: '巫师', data: [10, 7, 5, 5, 10, 9, 8], fill: true, backgroundColor: 'rgba(255, 99, 132, 0.2)', borderColor: 'rgb(255, 99, 132)', pointBackgroundColor: 'rgb(255, 99, 132)'},
                    { label: '亚马逊', data: [9, 9, 6, 2, 6, 4, 9], fill: true, backgroundColor: 'rgba(255, 205, 86, 0.2)', borderColor: 'rgb(255, 205, 86)', pointBackgroundColor: 'rgb(255, 205, 86)'},
                    { label: '猎法者', data: [8, 7, 7, 4, 7, 7, 9], fill: true, backgroundColor: 'rgba(75, 192, 192, 0.2)', borderColor: 'rgb(75, 192, 192)', pointBackgroundColor: 'rgb(75, 192, 192)'},
                    { label: '野蛮人', data: [6, 8, 8, 8, 5, 2, 6], fill: true, backgroundColor: 'rgba(255, 159, 64, 0.2)', borderColor: 'rgb(255, 159, 64)', pointBackgroundColor: 'rgb(255, 159, 64)'},
                    { label: '德鲁伊', data: [7, 6, 10, 8, 4, 6, 8], fill: true, backgroundColor: 'rgba(153, 102, 255, 0.2)', borderColor: 'rgb(153, 102, 255)', pointBackgroundColor: 'rgb(153, 102, 255)'},
                ]
            };
            chartInstance = new Chart(ctx, {
                type: 'radar',
                data: data,
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    elements: { line: { tension: 0.1 } },
                    plugins: {
                        title: { display: true, text: '七大职业综合能力雷达图', color: '#facc15', font: { size: 18 } },
                        legend: { 
                            position: 'bottom', 
                            labels: { color: '#d6d3d1' },
                            onHover: (event) => {
                                event.native.target.style.cursor = 'pointer';
                            },
                            onLeave: (event) => {
                                event.native.target.style.cursor = 'default';
                            }
                        }
                    },
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(168, 162, 158, 0.3)' },
                            grid: { color: 'rgba(168, 162, 158, 0.3)' },
                            pointLabels: { color: '#facc15', font: { size: 14 } },
                            ticks: {
                                backdropColor: '#1a1a1a',
                                color: '#d6d3d1',
                                stepSize: 2
                            },
                            min: 0,
                            max: 10
                        }
                    }
                }
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            renderNav();
            populateAIClassSelect();
            populateBpSelectors();
            navigate('home');
        });

